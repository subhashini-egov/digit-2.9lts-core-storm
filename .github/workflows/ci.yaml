name: CI

on:
  push:
    branches: [main, master, feature/*]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          # Remove unnecessary tools to free space
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h

      - name: Start services
        run: |
          docker compose up -d
          echo "Waiting for services to start..."

      - name: Wait for infrastructure
        run: |
          echo "Waiting for Postgres..."
          timeout 120 bash -c 'until docker exec docker-postgres pg_isready -U egov; do sleep 2; done'

          echo "Waiting for Redis..."
          timeout 60 bash -c 'until docker exec digit-redis redis-cli ping; do sleep 2; done'

          echo "Waiting for Redpanda..."
          timeout 120 bash -c 'until docker exec digit-redpanda rpk cluster health; do sleep 2; done'

          echo "Waiting for Elasticsearch..."
          timeout 120 bash -c 'until curl -sf http://localhost:19200/_cluster/health; do sleep 2; done'

      - name: Wait for all containers healthy
        run: |
          echo "Waiting for all containers to be healthy (up to 15 minutes)..."
          # Wait for all services to report healthy via Docker
          timeout 900 bash -c '
            while true; do
              UNHEALTHY=$(docker compose ps --format json | jq -r "select(.Health != \"healthy\" and .Health != \"\" and .State == \"running\") | .Name" | wc -l)
              TOTAL=$(docker compose ps --format json | jq -r "select(.State == \"running\") | .Name" | wc -l)
              echo "Healthy containers: $((TOTAL - UNHEALTHY))/$TOTAL"
              if [ "$UNHEALTHY" -eq 0 ] && [ "$TOTAL" -gt 0 ]; then
                echo "All containers healthy!"
                break
              fi
              sleep 10
            done
          '

      - name: Wait for seeds to complete
        run: |
          echo "Waiting for ALL seed containers to finish (no timeout)..."

          # List of all seed containers
          SEEDS="idgen-seed mdms-tenant-seed mdms-workflow-seed localization-seed db-seed"

          # Wait for each seed container to exit
          for seed in $SEEDS; do
            echo "Waiting for $seed..."
            while true; do
              STATUS=$(docker compose ps --format json | jq -r "select(.Service == \"$seed\") | .State" 2>/dev/null || echo "not_found")
              if [ "$STATUS" = "exited" ]; then
                # Check exit code
                EXIT_CODE=$(docker compose ps --format json | jq -r "select(.Service == \"$seed\") | .ExitCode" 2>/dev/null || echo "0")
                if [ "$EXIT_CODE" != "0" ]; then
                  echo "ERROR: $seed failed with exit code $EXIT_CODE"
                  docker compose logs "$seed"
                  exit 1
                fi
                echo "$seed completed successfully"
                break
              elif [ "$STATUS" = "not_found" ]; then
                echo "Waiting for $seed to start..."
              else
                echo "$seed status: $STATUS"
              fi
              sleep 5
            done
          done

          echo "All seeds completed successfully!"

      - name: Verify seed data ingestion
        run: |
          echo "=== Verifying seed data was ingested ==="

          # Check schema definitions in database
          echo "1. Checking MDMS schema definitions..."
          SCHEMA_COUNT=$(docker exec docker-postgres psql -U egov -d egov -t -c "SELECT COUNT(*) FROM eg_mdms_schema_definition WHERE isactive = true;")
          SCHEMA_COUNT=$(echo $SCHEMA_COUNT | tr -d ' ')
          echo "   Found $SCHEMA_COUNT active schema definitions"
          if [ "$SCHEMA_COUNT" -lt 10 ]; then
            echo "ERROR: Expected at least 10 schema definitions, found $SCHEMA_COUNT"
            exit 1
          fi

          # Check MDMS data records
          echo "2. Checking MDMS data records..."
          DATA_COUNT=$(docker exec docker-postgres psql -U egov -d egov -t -c "SELECT COUNT(*) FROM eg_mdms_data WHERE isactive = true;")
          DATA_COUNT=$(echo $DATA_COUNT | tr -d ' ')
          echo "   Found $DATA_COUNT active MDMS data records"
          if [ "$DATA_COUNT" -lt 100 ]; then
            echo "ERROR: Expected at least 100 MDMS data records, found $DATA_COUNT"
            exit 1
          fi

          # Check tenant data via API
          echo "3. Checking tenant data via MDMS API..."
          TENANT_RESPONSE=$(curl -sS -X POST "http://localhost:18094/mdms-v2/v1/_search" \
            -H 'Content-Type: application/json' \
            -d '{"RequestInfo":{"apiId":"digit","ver":"1.0","ts":0},"MdmsCriteria":{"tenantId":"pg","moduleDetails":[{"moduleName":"tenant","masterDetails":[{"name":"tenants"}]}]}}')
          if echo "$TENANT_RESPONSE" | grep -q '"tenantId"'; then
            echo "   Tenant data verified via API"
          else
            echo "ERROR: Tenant data not found via API"
            echo "$TENANT_RESPONSE"
            exit 1
          fi

          # Check localization data
          echo "4. Checking localization data..."
          LOC_COUNT=$(docker exec docker-postgres psql -U egov -d egov -t -c "SELECT COUNT(*) FROM message;")
          LOC_COUNT=$(echo $LOC_COUNT | tr -d ' ')
          echo "   Found $LOC_COUNT localization messages"
          if [ "$LOC_COUNT" -lt 1000 ]; then
            echo "ERROR: Expected at least 1000 localization messages, found $LOC_COUNT"
            exit 1
          fi

          # Check idgen sequence
          echo "5. Checking IDGEN sequences..."
          IDGEN_COUNT=$(docker exec docker-postgres psql -U egov -d egov -t -c "SELECT COUNT(*) FROM id_generator;")
          IDGEN_COUNT=$(echo $IDGEN_COUNT | tr -d ' ')
          echo "   Found $IDGEN_COUNT IDGEN sequences"
          if [ "$IDGEN_COUNT" -lt 1 ]; then
            echo "ERROR: Expected at least 1 IDGEN sequence, found $IDGEN_COUNT"
            exit 1
          fi

          echo "=== All seed data verification passed! ==="

      - name: Run health checks
        run: |
          bash scripts/health-check.sh http://localhost

      - name: Run smoke tests
        run: |
          bash scripts/smoke-tests.sh http://localhost

      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Logs ==="
          docker compose logs --tail=100

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v --remove-orphans
