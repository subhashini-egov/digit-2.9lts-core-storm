services:
  # Actual PostgreSQL - services should NOT connect directly to this
  postgres-db:
    image: postgres:16
    container_name: docker-postgres
    environment:
      POSTGRES_USER: egov
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      POSTGRES_DB: egov
    volumes:
    - postgres_data:/var/lib/docker-postgresql/data
    ports:
    - 15432:5432
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U egov
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
    - egov-network

  # PgBouncer - transparent connection pooler, aliased as "postgres"
  pgbouncer:
    image: edoburu/pgbouncer:latest
    container_name: digit-pgbouncer
    environment:
      DB_HOST: postgres-db
      DB_PORT: 5432
      DB_USER: egov
      DB_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      DB_NAME: egov
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 500
      DEFAULT_POOL_SIZE: 20
      MIN_POOL_SIZE: 5
      RESERVE_POOL_SIZE: 5
      AUTH_TYPE: scram-sha-256
    depends_on:
      postgres-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "5432", "-U", "egov"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      egov-network:
        aliases:
          - postgres

  redis:
    image: redis:7.2.4
    container_name: digit-redis
    ports:
    - 16379:6379
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
    - egov-network

  # Redpanda - Kafka-compatible streaming (keeping original for now, debugging separately)
  redpanda:
    image: redpandadata/redpanda:v24.1.1
    container_name: digit-redpanda
    command:
      - redpanda
      - start
      - --smp
      - '1'
      - --memory
      - 512M
      - --overprovisioned
      - --node-id
      - '0'
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr
      - PLAINTEXT://redpanda:9092
      - --pandaproxy-addr
      - PLAINTEXT://0.0.0.0:8082
      - --advertise-pandaproxy-addr
      - PLAINTEXT://redpanda:8082
    ports:
      - 19092:9092
      - 18082:8082
    healthcheck:
      test: ["CMD", "rpk", "cluster", "health"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - egov-network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.3
    container_name: digit-elasticsearch
    environment:
    - discovery.type=single-node
    - xpack.security.enabled=false
    - ES_JAVA_OPTS=-Xms256m -Xmx384m
    volumes:
    - es_data:/usr/share/elasticsearch/data
    ports:
    - 19200:9200
    healthcheck:
      test:
      - CMD-SHELL
      - curl -f http://localhost:9200/_cluster/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
    - egov-network

  egov-enc-service:
    image: egovio/egov-enc-service:v2.9.2-4a60f20
    container_name: egov-enc-service
    depends_on:
      egov-mdms-service:
        condition: service_healthy
      mdms-tenant-seed:
        condition: service_completed_successfully
    environment:
      SPRING_DATASOURCE_URL: jdbc:otel:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_FLYWAY_USER: egov
      SPRING_FLYWAY_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: 'true'
      SPRING_FLYWAY_VALIDATE_ON_MIGRATE: 'false'
      SPRING_FLYWAY_ENABLED: 'true'
      SPRING_FLYWAY_TABLE: enc_schema_version
      SERVER_PORT: 1234
      OTEL_TRACES_EXPORTER: none
      MASTER_PASSWORD: asd@#$@$!132123
      MASTER_SALT: qweasdzx
      MASTER_INITIALVECTOR: qweasdzxqwea
      MASTER_PASSWORD_PROVIDER: software
      EGOV_MDMS_HOST: http://egov-mdms-service:8094
      EGOV_MDMS_SEARCH_ENDPOINT: /mdms-v2/v1/_search
      EGOV_STATE_LEVEL_TENANT_ID: pg
      STATE_LEVEL_TENANT_ID: pg.citya
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx192m
    ports:
    - 11234:1234
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:1234/egov-enc-service/actuator/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
    - egov-network

  # MDMS Backend (actual service)
  mdms-backend:
    image: egovio/mdms-v2:v2.9.2-4a60f20
    container_name: mdms-backend
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:otel:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_FLYWAY_USER: egov
      SPRING_FLYWAY_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: 'true'
      SPRING_FLYWAY_VALIDATE_ON_MIGRATE: 'false'
      SPRING_FLYWAY_ENABLED: 'true'
      SPRING_FLYWAY_TABLE: mdms_schema_version
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SERVER_PORT: 8094
      OTEL_TRACES_EXPORTER: none
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx192m
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8094/mdms-v2/health >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
    networks:
    - egov-network

  # MDMS Proxy - handles path rewriting for backward compatibility
  # Rewrites /egov-mdms-service/* to /mdms-v2/* for older services
  egov-mdms-service:
    image: nginx:alpine
    container_name: egov-mdms-service
    depends_on:
      mdms-backend:
        condition: service_healthy
    volumes:
      - ./nginx/mdms-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
    - 18094:8094
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8094/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
    - egov-network

  egov-idgen:
    image: egovio/egov-idgen:v2.9.2-4a60f20
    container_name: egov-idgen
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      egov-mdms-service:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.postgresql.Driver
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_FLYWAY_USER: egov
      SPRING_FLYWAY_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_FLYWAY_ENABLED: 'true'
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: 'true'
      SPRING_FLYWAY_VALIDATE_ON_MIGRATE: 'false'
      SPRING_FLYWAY_TABLE: idgen_schema_version
      SPRING_FLYWAY_LOCATIONS: classpath:db/migration/main
      EGOV_MDMS_HOST: http://egov-mdms-service:8094/
      MDMS_HOST: http://egov-mdms-service:8094/
      EGOV_MDMS_SEARCH_ENDPOINT: mdms-v2/v1/_search
      MDMS_SERVICE_HOST: http://egov-mdms-service:8094/
      MDMS_SERVICE_SEARCH_URI: mdms-v2/v1/_search
      AUTOCREATE_NEW_SEQ: 'true'
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SERVER_PORT: 8088
      OTEL_TRACES_EXPORTER: none
      MANAGEMENT_HEALTH_DB_ENABLED: 'false'
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx192m
    ports:
    - 18088:8088
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8088/egov-idgen/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
    - egov-network

  # Unified database migrations for all DIGIT services
  # Runs all Flyway migrations in one container before services start
  db-migrations:
    build:
      context: ./docker/db-migrations
      dockerfile: Dockerfile
    depends_on:
      pgbouncer:
        condition: service_healthy
    environment:
      DB_URL: jdbc:postgresql://postgres:5432/egov
      FLYWAY_USER: egov
      FLYWAY_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
    networks:
      - egov-network
    restart: "no"

  egov-user:
    image: egovio/egov-user:v2_migration-cc51289
    container_name: egov-user
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      redis:
        condition: service_healthy
      egov-enc-service:
        condition: service_healthy
      mdms-tenant-seed:
        condition: service_completed_successfully
      mdms-security-seed:
        condition: service_completed_successfully
      db-migrations:
        condition: service_completed_successfully
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      # Flyway disabled - migrations run by db-migrations container
      FLYWAY_ENABLED: 'false'
      # Kafka config - use property name expected by egov-user
      KAFKA_CONFIG_BOOTSTRAP_SERVER_CONFIG: redpanda:9092
      SPRING_KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SERVER_PORT: 8107
      EGOV_MDMS_HOST: http://egov-mdms-service:8094
      EGOV_MDMS_SEARCH_ENDPOINT: /mdms-v2/v1/_search
      MDMS_HOST: http://egov-mdms-service:8094
      MDMS_V2_HOST: http://egov-mdms-service:8094
      EGOV_MDMS_V2_HOST: http://egov-mdms-service:8094
      MDMS_SEARCH_ENDPOINT: /mdms-v2/v1/_search
      EGOV_OTP_HOST: http://egov-user:8107
      EGOV_ENC_HOST: http://egov-enc-service:1234
      EGOV_IDGEN_HOST: http://egov-idgen:8088
      EGOV_ACCESSCONTROL_HOST: http://egov-accesscontrol:8090
      EGOV_STATE_LEVEL_TENANT_ID: pg
      STATE_LEVEL_TENANT_ID: pg
      OTEL_TRACES_EXPORTER: none
      JAVA_TOOL_OPTIONS: -Xms128m -Xmx384m
    ports:
    - 18107:8107
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8107/user/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
    - egov-network

  egov-workflow-v2:
    image: egovio/egov-workflow-v2:v2.9.2-4a60f20
    container_name: egov-workflow-v2
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      mdms-workflow-seed:
        condition: service_completed_successfully
    environment:
      SPRING_DATASOURCE_URL: jdbc:otel:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_FLYWAY_USER: egov
      SPRING_FLYWAY_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: 'true'
      SPRING_FLYWAY_VALIDATE_ON_MIGRATE: 'false'
      SPRING_FLYWAY_ENABLED: 'true'
      SPRING_FLYWAY_TABLE: workflow_schema_version
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SERVER_PORT: 8109
      EGOV_MDMS_HOST: http://egov-mdms-service:8094/
      EGOV_MDMS_SEARCH_ENDPOINT: mdms-v2/v1/_search
      EGOV_USER_HOST: http://egov-user:8107/
      STATE_LEVEL_TENANT_ID: pg.citya
      EGOV_STATE_LEVEL_TENANT_ID: pg
      OTEL_TRACES_EXPORTER: none
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx256m
    ports:
    - 18109:8109
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8109/egov-workflow-v2/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
    - egov-network

  egov-localization:
    image: egovio/egov-localization:v2.9.2-4a60f20
    container_name: egov-localization
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:otel:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_FLYWAY_USER: egov
      SPRING_FLYWAY_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: 'true'
      SPRING_FLYWAY_VALIDATE_ON_MIGRATE: 'false'
      SPRING_FLYWAY_ENABLED: 'true'
      SPRING_FLYWAY_TABLE: localization_schema_version
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SERVER_PORT: 8096
      OTEL_TRACES_EXPORTER: none
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx256m
    ports:
    - 18096:8096
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8096/localization/actuator/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
    - egov-network

  egov-location:
    image: egovio/egov-location:v2.9.2-4a60f20
    container_name: egov-location
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_FLYWAY_USER: egov
      SPRING_FLYWAY_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: 'true'
      SPRING_FLYWAY_VALIDATE_ON_MIGRATE: 'false'
      SPRING_FLYWAY_ENABLED: 'true'
      SPRING_FLYWAY_TABLE: location_schema_version
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SERVER_PORT: 8084
      EGOV_MDMS_HOST: http://egov-mdms-service:8094/
      OTEL_TRACES_EXPORTER: none
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx192m
    ports:
    - 18084:8084
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8084/egov-location/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
    - egov-network

  boundary-service:
    image: egovio/boundary-service:v2.9.2-4a60f20
    container_name: boundary-service
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      egov-mdms-service:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_FLYWAY_USER: egov
      SPRING_FLYWAY_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: 'true'
      SPRING_FLYWAY_VALIDATE_ON_MIGRATE: 'false'
      SPRING_FLYWAY_ENABLED: 'true'
      SPRING_FLYWAY_TABLE: boundary_schema_version
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SPRING_KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SERVER_PORT: 8081
      SERVER_SERVLET_CONTEXT_PATH: /boundary-service
      EGOV_MDMS_HOST: http://egov-mdms-service:8094
      EGOV_MDMS_SEARCH_ENDPOINT: /mdms-v2/v1/_search
      EGOV_USER_HOST: http://egov-user:8107
      EGOV_IDGEN_HOST: http://egov-idgen:8088
      EGOV_LOCALIZATION_HOST: http://egov-localization:8096
      STATE_LEVEL_TENANT_ID: pg
      OTEL_TRACES_EXPORTER: none
      MANAGEMENT_HEALTH_DB_ENABLED: 'false'
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx192m
    ports:
    - 18081:8081
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8081/boundary-service/actuator/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
    - egov-network

  egov-accesscontrol:
    image: egovio/egov-accesscontrol:v2.9.2-4a60f20
    container_name: egov-accesscontrol
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:otel:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_FLYWAY_USER: egov
      SPRING_FLYWAY_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: 'true'
      SPRING_FLYWAY_VALIDATE_ON_MIGRATE: 'false'
      SPRING_FLYWAY_ENABLED: 'true'
      SPRING_FLYWAY_TABLE: accesscontrol_schema_version
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SERVER_PORT: 8090
      EGOV_MDMS_HOST: http://egov-mdms-service:8094/
      OTEL_TRACES_EXPORTER: none
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx192m
    ports:
    - 18090:8090
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8090/access/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
    - egov-network

  egov-persister:
    image: egovio/egov-persister:v2.9.2-4a60f20
    container_name: egov-persister
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:otel:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SERVER_PORT: 8091
      EGOV_PERSIST_YML_REPO_PATH: /persister-config/
      OTEL_TRACES_EXPORTER: none
      JAVA_TOOL_OPTIONS: -Xms64m -Xmx192m
    volumes:
    - ./configs/persister:/persister-config:ro
    ports:
    - 18091:8091
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8091/common-persist/actuator/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
    - egov-network

  mdms-tenant-seed:
    image: postgres:16
    depends_on:
      pgbouncer:
        condition: service_healthy
      mdms-backend:
        condition: service_healthy
    volumes:
      - ./db/tenant-seed.sql:/tenant-seed.sql:ro
    entrypoint: >
      bash -c "
        echo 'Waiting for MDMS tables to be created by Flyway...';
        until psql postgresql://egov:${POSTGRES_PASSWORD:-egov123}@postgres:5432/egov -c 'SELECT 1 FROM eg_mdms_schema_definition LIMIT 1' >/dev/null 2>&1; do
          echo 'MDMS tables not ready, waiting...';
          sleep 2;
        done;
        echo 'MDMS tables ready. Seeding tenant master...';
        psql postgresql://egov:${POSTGRES_PASSWORD:-egov123}@postgres:5432/egov -f /tenant-seed.sql
        echo 'Tenant seed complete'
      "
    networks:
      - egov-network
    restart: "no"

  mdms-workflow-seed:
    image: postgres:16
    depends_on:
      pgbouncer:
        condition: service_healthy
      mdms-backend:
        condition: service_healthy
      mdms-tenant-seed:
        condition: service_completed_successfully
    volumes:
      - ./db/mdms-workflow-seed.sql:/workflow-seed.sql:ro
    entrypoint: >
      bash -c "
        echo 'Waiting for MDMS tables...';
        until psql postgresql://egov:${POSTGRES_PASSWORD:-egov123}@postgres:5432/egov -c 'SELECT 1 FROM eg_mdms_schema_definition LIMIT 1' >/dev/null 2>&1; do
          echo 'MDMS tables not ready, waiting...';
          sleep 2;
        done;
        echo 'Seeding workflow business service config...';
        psql postgresql://egov:${POSTGRES_PASSWORD:-egov123}@postgres:5432/egov -f /workflow-seed.sql
        echo 'Workflow MDMS seed complete'
      "
    networks:
      - egov-network
    restart: "no"

  mdms-security-seed:
    image: postgres:16
    depends_on:
      pgbouncer:
        condition: service_healthy
      mdms-backend:
        condition: service_healthy
      mdms-tenant-seed:
        condition: service_completed_successfully
    volumes:
      - ./db/mdms-security-seed.sql:/security-seed.sql:ro
    entrypoint: >
      bash -c "
        echo 'Waiting for MDMS tables...';
        until psql postgresql://egov:${POSTGRES_PASSWORD:-egov123}@postgres:5432/egov -c 'SELECT 1 FROM eg_mdms_schema_definition LIMIT 1' >/dev/null 2>&1; do
          echo 'MDMS tables not ready, waiting...';
          sleep 2;
        done;
        echo 'Seeding Security MDMS configs...';
        psql postgresql://egov:${POSTGRES_PASSWORD:-egov123}@postgres:5432/egov -f /security-seed.sql
        echo 'Security MDMS seed complete'
      "
    networks:
      - egov-network
    restart: "no"

  localization-seed:
    image: postgres:16
    depends_on:
      pgbouncer:
        condition: service_healthy
      egov-localization:
        condition: service_healthy
    volumes:
      - ./db/localization-seed.sql:/localization-seed.sql:ro
    entrypoint: >
      bash -c "
        echo 'Seeding localization data...';
        psql postgresql://egov:${POSTGRES_PASSWORD:-egov123}@postgres:5432/egov -f /localization-seed.sql
        echo 'Localization seed complete'
      "
    networks:
      - egov-network
    restart: "no"

  db-seed:
    image: postgres:16
    container_name: db-seed-container
    depends_on:
      pgbouncer:
        condition: service_healthy
      egov-mdms-service:
        condition: service_healthy
      mdms-tenant-seed:
        condition: service_completed_successfully
      mdms-workflow-seed:
        condition: service_completed_successfully
      mdms-security-seed:
        condition: service_completed_successfully
      localization-seed:
        condition: service_completed_successfully
      egov-workflow-v2:
        condition: service_healthy
      egov-localization:
        condition: service_healthy
      egov-accesscontrol:
        condition: service_healthy
    volumes:
      - ./db/seed.sql:/seed.sql:ro
    entrypoint: >
      bash -c "
        echo 'Waiting for MDMS tables...';
        until psql postgresql://egov:${POSTGRES_PASSWORD:-egov123}@postgres:5432/egov -c 'SELECT 1 FROM eg_mdms_schema_definition LIMIT 1' >/dev/null 2>&1; do
          echo 'MDMS tables not ready, waiting...';
          sleep 2;
        done;
        echo 'Running seed.sql...';
        psql postgresql://egov:${POSTGRES_PASSWORD:-egov123}@postgres:5432/egov -f /seed.sql
        echo 'Done loading seed data'
      "
    networks:
      - egov-network
    restart: "no"

  # ===========================================================================
  # PGR Services (Public Grievance Redressal)
  # ===========================================================================
  pgr-services:
    image: pgr-services-dev
    container_name: pgr-services
    depends_on:
      pgbouncer:
        condition: service_healthy
      redpanda:
        condition: service_healthy
      egov-mdms-service:
        condition: service_healthy
      egov-idgen:
        condition: service_healthy
      egov-user:
        condition: service_healthy
      egov-workflow-v2:
        condition: service_healthy
      egov-localization:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_DATASOURCE_USERNAME: egov
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "5"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "2"
      SPRING_FLYWAY_URL: jdbc:postgresql://postgres:5432/egov
      SPRING_FLYWAY_USER: egov
      SPRING_FLYWAY_PASSWORD: ${POSTGRES_PASSWORD:-egov123}
      SPRING_FLYWAY_ENABLED: 'true'
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: 'true'
      SPRING_FLYWAY_VALIDATE_ON_MIGRATE: 'false'
      SPRING_FLYWAY_TABLE: pgr_services_schema
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SPRING_KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SPRING_KAFKA_CONSUMER_GROUP_ID: egov-pgr-services
      SERVER_PORT: 8080
      EGOV_IDGEN_HOST: http://egov-idgen:8088/
      EGOV_WORKFLOW_HOST: http://egov-workflow-v2:8109/
      EGOV_MDMS_HOST: http://egov-mdms-service:8094/
      EGOV_LOCALIZATION_HOST: http://egov-localization:8096/
      EGOV_USER_HOST: http://egov-user:8107/
      EGOV_LOCATION_HOST: http://egov-location:8084/
      EGOV_HRMS_HOST: http://egov-user:8107/
      EGOV_URL_SHORTNER_HOST: http://egov-url-shortening:8080/
      EGOV_UI_APP_HOST: http://localhost:18080
      NOTIFICATION_SMS_ENABLED: 'false'
      NOTIFICATION_EMAIL_ENABLED: 'false'
      NEW_COMPLAINT_ENABLED: 'true'
      REASSIGN_COMPLAINT_ENABLED: 'true'
      REOPEN_COMPLAINT_ENABLED: 'true'
      COMMENT_BY_EMPLOYEE_NOTIF_ENABLED: 'false'
      NOTIFICATION_ALLOWED_ON_STATUS: 'open,assigned,rejected,resolved'
      EGOV_USR_EVENTS_NOTIFICATION_ENABLED: 'true'
      EGOV_USR_EVENTS_CREATE_TOPIC: persist-user-events-async
      PGR_STATELEVEL_TENANTID: pg
      STATE_LEVEL_TENANT_ID: pg
      EGOV_STATE_LEVEL_TENANT_ID: pg
      JAVA_OPTS: '-Xmx192m -Xms192m'
      OTEL_TRACES_EXPORTER: none
    ports:
      - "18083:8080"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/pgr-services/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - egov-network

  # ===========================================================================
  # DIGIT UI (React Frontend)
  # Image built by Tilt from CCRS repo, or manually with:
  # docker build -t digit-ui-dev -f ../Citizen-Complaint-Resolution-System/frontend/micro-ui/web/docker/Dockerfile ../Citizen-Complaint-Resolution-System/frontend/micro-ui
  # ===========================================================================
  digit-ui:
    image: digit-ui-dev
    container_name: digit-ui
    ports:
      - "18080:80"
    volumes:
      # Mount globalConfigs for runtime configuration (don't mount index.html - built image has it with bundle scripts)
      # CCRS_PATH can be overridden via environment variable, defaults to sibling directory
      - ${CCRS_PATH:-../Citizen-Complaint-Resolution-System}/configs/assets/globalConfigsPGR.js:/var/web/digit-ui/globalConfigs.js:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:80/ >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - egov-network

  # ===========================================================================
  # Kong API Gateway (DB-less mode)
  # Main entry point: http://localhost:18000/digit-ui/
  # ===========================================================================
  kong:
    image: kong:3.6
    container_name: kong-gateway
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_GUI_URL: http://localhost:8002
      KONG_STATUS_LISTEN: 0.0.0.0:8100
      KONG_MEM_CACHE_SIZE: 64m
      KONG_NGINX_WORKER_PROCESSES: 1
    deploy:
      resources:
        limits:
          memory: 512M
    volumes:
      - ./kong/kong.yml:/kong/kong.yml:ro
    ports:
      - "18000:8000"   # Proxy (HTTP)
      - "18443:8443"   # Proxy (HTTPS)
      - "18001:8001"   # Admin API
      - "18002:8002"   # Kong Manager GUI
      - "18100:8100"   # Status endpoint
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      egov-mdms-service:
        condition: service_healthy
      egov-user:
        condition: service_healthy
    networks:
      - egov-network

  # ==================== Gatus Health Monitoring ====================
  gatus:
    image: twinproduction/gatus:latest
    container_name: digit-gatus
    depends_on:
      pgbouncer:
        condition: service_healthy
      egov-mdms-service:
        condition: service_healthy
    volumes:
      - ./gatus/config.yaml:/config/config.yaml:ro
    ports:
      - "18889:8080"
    environment:
      GATUS_CONFIG_PATH: /config/config.yaml
    networks:
      - egov-network
    profiles:
      - tools

  # ==================== Jupyter Lab for PGR Configuration ====================
  jupyter:
    build:
      context: ./jupyter
      dockerfile: Dockerfile
    container_name: digit-jupyter
    depends_on:
      egov-mdms-service:
        condition: service_healthy
      egov-user:
        condition: service_healthy
      kong:
        condition: service_healthy
    environment:
      DIGIT_URL: http://kong:8000
      DIGIT_DIRECT_MDMS: http://egov-mdms-service:8094
      DIGIT_DIRECT_USER: http://egov-user:8107
      DIGIT_DIRECT_PGR: http://pgr-services:8080
      DIGIT_TENANT: pg
      JUPYTER_ENABLE_LAB: "yes"
    ports:
      - "18888:8888"
    volumes:
      - ./jupyter/dataloader/templates:/home/jovyan/work/templates
    networks:
      - egov-network
    profiles:
      - tools

networks:
  egov-network:
    driver: bridge

volumes:
  postgres_data: null
  es_data: null
  filestore_data: null
